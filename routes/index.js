const JTT809header = require('../public/protocol/809/JTT809Header')
const JTT809body1001 = require('../public/protocol/809/JTT809Body1001')
const JTT809body1002 = require('../public/protocol/809/JTT809Body1002')
const JTT809body1003 = require('../public/protocol/809/JTT809Body1003')
const JTT809body1004 = require('../public/protocol/809/JTT809Body1004')
const JTT809body1005 = require('../public/protocol/809/JTT809Body1005')
const JTT809body1006 = require('../public/protocol/809/JTT809Body1006')
const JTT809body1007 = require('../public/protocol/809/JTT809Body1007')
const JTT809body1008 = require('../public/protocol/809/JTT809Body1008')

const JTT809body9001 = require('../public/protocol/809/JTT809Body9001')
const JTT809body9002 = require('../public/protocol/809/JTT809Body9002')
const JTT809body9003 = require('../public/protocol/809/JTT809Body9003')
const JTT809body9004 = require('../public/protocol/809/JTT809Body9004')
const JTT809body9005 = require('../public/protocol/809/JTT809Body9005')
const JTT809body9006 = require('../public/protocol/809/JTT809Body9006')
const JTT809body9007 = require('../public/protocol/809/JTT809Body9007')
const JTT809body9008 = require('../public/protocol/809/JTT809Body9008')

const JTT809body9101 = require('../public/protocol/809/JTT809Body9101')
const JTT809body1200 = require('../public/protocol/809/JTT809Body1200')
const JTT809body1300 = require('../public/protocol/809/JTT809Body1300')
const JTT809body9200 = require('../public/protocol/809/JTT809Body9200')
const JTT809body9300 = require('../public/protocol/809/JTT809Body9300')
const JTT809body1400 = require('../public/protocol/809/JTT809Body1400')
const JTT809body9400 = require('../public/protocol/809/JTT809Body9400')
const JTT809body1500 = require('../public/protocol/809/JTT809Body1500')
const JTT809body9500 = require('../public/protocol/809/JTT809Body9500')
const JTT809body1600 = require('../public/protocol/809/JTT809Body1600')
const JTT809body9600 = require('../public/protocol/809/JTT809Body9600')

const JTT808Header = require('../public/protocol/808/JTT808Header')
const JTT808Body0a00 = require('../public/protocol/808/JTT808Body0a00')
const JTT808Body0001 = require('../public/protocol/808/JTT808Body0001')
const JTT808Body0002 = require('../public/protocol/808/JTT808Body0002')
const JTT808Body0003 = require('../public/protocol/808/JTT808Body0003')
const JTT808Body8a00 = require('../public/protocol/808/JTT808Body8a00')
const JTT808Body0100 = require('../public/protocol/808/JTT808Body0100')
const JTT808Body0102 = require('../public/protocol/808/JTT808Body0102')
const JTT808Body0104 = require('../public/protocol/808/JTT808Body0104')
const JTT808Body0107 = require('../public/protocol/808/JTT808Body0107')
const JTT808Body0108 = require('../public/protocol/808/JTT808Body0108')
const JTT808Body0200 = require('../public/protocol/808/JTT808Body0200')
const JTT808Body0201 = require('../public/protocol/808/JTT808Body0201')
const JTT808Body0301 = require('../public/protocol/808/JTT808Body0301')
const JTT808Body0302 = require('../public/protocol/808/JTT808Body0302')
const JTT808Body0303 = require('../public/protocol/808/JTT808Body0303')
const JTT808Body0500 = require('../public/protocol/808/JTT808Body0500')
const JTT808Body0700 = require('../public/protocol/808/JTT808Body0700')
const JTT808Body0701 = require('../public/protocol/808/JTT808Body0701')
const JTT808Body0702 = require('../public/protocol/808/JTT808Body0702')
const JTT808Body0704 = require('../public/protocol/808/JTT808Body0704')
const JTT808Body0705 = require('../public/protocol/808/JTT808Body0705')

const JTT808Body0805 = require('../public/protocol/808/JTT808Body0805')
const JTT808Body0800 = require('../public/protocol/808/JTT808Body0800')
const JTT808Body0801 = require('../public/protocol/808/JTT808Body0801')
const JTT808Body0802 = require('../public/protocol/808/JTT808Body0802')
const JTT808Body8001 = require('../public/protocol/808/JTT808Body8001')
const JTT808Body8003 = require('../public/protocol/808/JTT808Body8003')
const JTT808Body8301 = require('../public/protocol/808/JTT808Body8301')
const JTT808Body8401 = require('../public/protocol/808/JTT808Body8401')
const JTT808Body8100 = require('../public/protocol/808/JTT808Body8100')
const JTT808Body8108 = require('../public/protocol/808/JTT808Body8108')
const JTT808Body0900 = require('../public/protocol/808/JTT808Body0900')
const JTT808Body0901 = require('../public/protocol/808/JTT808Body0901')
const JTT808Body8103 = require('../public/protocol/808/JTT808Body8103')
const JTT808Body8104 = require('../public/protocol/808/JTT808Body8104')
const JTT808Body8105 = require('../public/protocol/808/JTT808Body8105')
const JTT808Body8106 = require('../public/protocol/808/JTT808Body8106')
const JTT808Body8202 = require('../public/protocol/808/JTT808Body8202')
const JTT808Body8203 = require('../public/protocol/808/JTT808Body8203')
const JTT808Body8300 = require('../public/protocol/808/JTT808Body8300')

const JTT808Body8302 = require('../public/protocol/808/JTT808Body8302')
const JTT808Body8303 = require('../public/protocol/808/JTT808Body8303')
const JTT808Body8304 = require('../public/protocol/808/JTT808Body8304')
const JTT808Body8400 = require('../public/protocol/808/JTT808Body8400')
const JTT808Body8500 = require('../public/protocol/808/JTT808Body8500')

const JTT808Body8600 = require('../public/protocol/808/JTT808Body8600')
const JTT808Body8601 = require('../public/protocol/808/JTT808Body8601')
const JTT808Body8602 = require('../public/protocol/808/JTT808Body8602')
const JTT808Body8603 = require('../public/protocol/808/JTT808Body8603')

const JTT808Body8604 = require('../public/protocol/808/JTT808Body8604')
const JTT808Body8605 = require('../public/protocol/808/JTT808Body8605')
const JTT808Body8606 = require('../public/protocol/808/JTT808Body8606')
const JTT808Body8607 = require('../public/protocol/808/JTT808Body8607')
const JTT808Body8700 = require('../public/protocol/808/JTT808Body8700')
const JTT808Body8701 = require('../public/protocol/808/JTT808Body8701')

const JTT808Body8800 = require('../public/protocol/808/JTT808Body8800')
const JTT808Body8801 = require('../public/protocol/808/JTT808Body8801')
const JTT808Body8802 = require('../public/protocol/808/JTT808Body8802')
const JTT808Body8803 = require('../public/protocol/808/JTT808Body8803')
const JTT808Body8804 = require('../public/protocol/808/JTT808Body8804')
const JTT808Body8805 = require('../public/protocol/808/JTT808Body8805')
const JTT808Body8900 = require('../public/protocol/808/JTT808Body8900')

const JTT809Header = new JTT809header()

const JTT808header = new JTT808Header()
const JTT808body0a00 = new JTT808Body0a00()
const JTT808body0001 = new JTT808Body0001()
const JTT808body0002 = new JTT808Body0002()
const JTT808body0003 = new JTT808Body0003()
const JTT808body8a00 = new JTT808Body8a00()
const JTT808body0100 = new JTT808Body0100()
const JTT808body0102 = new JTT808Body0102()
const JTT808body0104 = new JTT808Body0104()
const JTT808body0107 = new JTT808Body0107()
const JTT808body0108 = new JTT808Body0108()
const JTT808body0200 = new JTT808Body0200()
const JTT808body0201 = new JTT808Body0201()
const JTT808body0301 = new JTT808Body0301()
const JTT808body0302 = new JTT808Body0302()
const JTT808body0303 = new JTT808Body0303()

const JTT808body0500 = new JTT808Body0500()
const JTT808body0700 = new JTT808Body0700()
const JTT808body0701 = new JTT808Body0701()
const JTT808body0702 = new JTT808Body0702()
const JTT808body0704 = new JTT808Body0704()
const JTT808body0705 = new JTT808Body0705()

const JTT808body0800 = new JTT808Body0800()
const JTT808body0801 = new JTT808Body0801()
const JTT808body0802 = new JTT808Body0802()
const JTT808body0805 = new JTT808Body0805()
const JTT808body8001 = new JTT808Body8001()
const JTT808body8003 = new JTT808Body8003()
const JTT808body8100 = new JTT808Body8100()
const JTT808body8108 = new JTT808Body8108()
const JTT808body8103 = new JTT808Body8103()
const JTT808body8104 = new JTT808Body8104()
const JTT808body8105 = new JTT808Body8105()
const JTT808body8106 = new JTT808Body8106()
const JTT808body8202 = new JTT808Body8202()

const JTT808body8203 = new JTT808Body8203()
const JTT808body8300 = new JTT808Body8300()
const JTT808body8301 = new JTT808Body8301()
const JTT808body8302 = new JTT808Body8302()
const JTT808body8303 = new JTT808Body8303()
const JTT808body8304 = new JTT808Body8304()
const JTT808body8400 = new JTT808Body8400()
const JTT808body8401 = new JTT808Body8401()

const JTT808body8500 = new JTT808Body8500()

const JTT808body8600 = new JTT808Body8600()
const JTT808body8601 = new JTT808Body8601()
const JTT808body8602 = new JTT808Body8602()
const JTT808body8603 = new JTT808Body8603()

const JTT808body8604 = new JTT808Body8604()
const JTT808body8605 = new JTT808Body8605()

const JTT808body8606 = new JTT808Body8606()
const JTT808body8607 = new JTT808Body8607()

const JTT808body8700 = new JTT808Body8700()
const JTT808body8701 = new JTT808Body8701()
const JTT808body8800 = new JTT808Body8800()
const JTT808body8801 = new JTT808Body8801()
const JTT808body8802 = new JTT808Body8802()
const JTT808body8803 = new JTT808Body8803()
const JTT808body8804 = new JTT808Body8804()
const JTT808body8805 = new JTT808Body8805()
const JTT808body8900 = new JTT808Body8900()


const JTT808body0900 = new JTT808Body0900()
const JTT808body0901 = new JTT808Body0901()

const router = require('koa-router')()
const net = require('net')

var NodeRSA = require('node-rsa');
var key = new NodeRSA({ b: 1024 })

let client808 = null
const servers = {}
const clients = {}
const sockets = {}
let interval = null
let centerId = 5230
let phoneNumber = '081181117090'
let flow_number = 1

const login_result_808 = {
  0: '成功',
  1: '车辆已被注册',
  2: '数据库中无该车辆',
  3: '终端已被注册',
  4: '数据库中无该终端'
}

const main_link = {
  '1001': new JTT809body1001(),
  '1002': new JTT809body1002(),
  '1003': new JTT809body1003(),
  '1004': new JTT809body1004(),
  '1005': new JTT809body1005(),
  '1006': new JTT809body1006(),
  '1007': new JTT809body1007(),
  '1008': new JTT809body1008(),

  '1200': new JTT809body1200(),
  '1300': new JTT809body1300(),
  '1400': new JTT809body1400(),
  '1500': new JTT809body1500(),
  '1600': new JTT809body1600(),

}

const slave_link = {
  '9001': new JTT809body9001(),
  '9002': new JTT809body9002(),
  '9003': new JTT809body9003(),
  '9004': new JTT809body9004(),
  '9005': new JTT809body9005(),
  '9006': new JTT809body9006(),
  '9007': new JTT809body9007(),
  '9008': new JTT809body9008(),

  '9101': new JTT809body9101(),
  '9200': new JTT809body9200(),
  '9300': new JTT809body9300(),
  '9400': new JTT809body9400(),
  '9500': new JTT809body9500(),
  '9600': new JTT809body9600(),

}

const MESSAGE = {
  '0a00': JTT808body0a00,
  // 终端通用应答消息体数据格式
  '0001': JTT808body0001,
  // 终端心跳数据消息体为空
  '0002': JTT808body0002,
  // 终端注销消息体为空
  '0003': JTT808body0003,
  '8a00': JTT808body8a00,
  // 终端注册消息体
  '0100': JTT808body0100,
  // 终端鉴权消息体
  '0102': JTT808body0102,
  // 查询终端参数应答消息体
  '0104': JTT808body0104,
  // 查询终端属性应答消息体
  '0107': JTT808body0107,
  // 终端在升级完成并重新连接后使用该命令通知监控中心
  '0108': JTT808body0108,
  // 位置信息汇报消息体
  '0200': JTT808body0200,
  // 位置信息查询应答消息体
  '0201': JTT808body0201,
  // 事件报告消息体
  '0301': JTT808body0301,
  // 提问应答消息体
  '0302': JTT808body0302,
  // 消息点播/取消消息体
  '0303': JTT808body0303,
  // 车辆控制应答消息体
  '0500': JTT808body0500,
  // 行驶记录数据上传消息体
  '0700': JTT808body0700,
  // 电子运单上报消息体
  '0701': JTT808body0701,
  // 驾驶员身份信息采集上报 
  '0702': JTT808body0702,
  // 定位数据批量上传数据
  '0704': JTT808body0704,
  // CAN 总线数据上传 
  '0705': JTT808body0705,
  // 多媒体事件信息上传 
  '0800': JTT808body0800,
  // 多媒体数据上传 
  '0801': JTT808body0801,
  // 存储多媒体数据检索应答
  '0802': JTT808body0802,
  // 摄像头立即拍摄命令应答 
  '0805': JTT808body0805,
  // 数据上行透传消息体
  '0900': JTT808body0900,
  //  数据压缩上报 
  '0901': JTT808body0901,
  // 平台通用应答 
  '8001': JTT808body8001,
  // 补传分包请求 
  '8003': JTT808body8003,
  // 终端注册应答 
  '8100': JTT808body8100,
  // 设置终端参数 
  '8103': JTT808body8103,
  // 查询终端参数消息体为空
  '8104': JTT808body8104,
  // 终端控制消息体
  '8105': JTT808body8105,
  // 查询指定终端参数消息体数据
  '8106': JTT808body8106,
  // '8107': JTT808body8107,
  // 下发终端升级包消息体数据
  '8108': JTT808body8108,
  // 临时位置跟踪控制消息体数据
  '8202': JTT808body8202,
  // 人工确认报警消息体数据
  '8203': JTT808body8203,
  // 文本信息下发消息体
  '8300': JTT808body8300,
  // 事件设置消息体数据
  '8301': JTT808body8301,
  // 提问下发消息体数据
  '8302': JTT808body8302,
  // 信息点播菜单设置消息体数据
  '8303': JTT808body8303,
  // 信息服务消息体数据
  '8304': JTT808body8304,
  // 电话回拨消息体数据格式
  '8400': JTT808body8400,
  // 设置电话本消息体数据
  '8401': JTT808body8401,
  // 车辆控制消息体数据
  '8500': JTT808body8500,
  // 设置圆形区域消息体数据
  '8600': JTT808body8600,

  '8601': JTT808body8601,

  '8602': JTT808body8602,

  '8603': JTT808body8603,
  '8604': JTT808body8604,

  '8605': JTT808body8605,
  '8606': JTT808body8606,
  '8607': JTT808body8607,

  // 行驶记录数据采集命令消息体
  '8700': JTT808body8700,
  // 行驶记录参数下传命令
  '8701': JTT808body8701,
  // 多媒体数据上传应答消息体
  '8800': JTT808body8800,
  // 摄像头立即拍摄命令消息体
  '8801': JTT808body8801,
  // 存储多媒体数据检索消息体
  '8802': JTT808body8802,
  // 存储多媒体数据上传命令消息体
  '8803': JTT808body8803,
  // 录音开始命令消息体数据
  '8804': JTT808body8804,
  // 单条存储多媒体数据检索上传命令消息体
  '8805': JTT808body8805,
  // 数据下行透传消息体
  '8900': JTT808body8900,
}

function encode_809(header, body) {
  let body_buf = Buffer.from([])
  if (header.message_id in main_link) {
    body_buf = main_link[header.message_id].encode(body)
  } else if (header.message_id in slave_link) {
    body_buf = slave_link[header.message_id].encode(body)
  }
  if (header.encrypt_flag === 1) {
    body_buf = JTT809Header.encrypt(header.encrypt_key, body_buf)
  }
  header.body_length = body_buf.length
  const header_buf = JTT809Header.encode(header)
  const crc = JTT809Header.fill(Buffer.concat([header_buf, body_buf]))
  const escaped = JTT809Header.escape(crc)
  const head_flag = Buffer.from([0x5b])
  const end_flag = Buffer.from([0x5d])
  const message = Buffer.concat([head_flag, escaped, end_flag])
  return message
}

function decode_809(buffer) {
  const data = JTT809Header.unescape(buffer.slice(1, -1))
  if (JTT809Header.validate(data)) {
    const header_body_data = data.slice(0, -2)
    const header = JTT809Header.decode(header_body_data.slice(0, 22))
    let body_data = header_body_data.slice(22)
    if (header.encrypt_flag === 1) {
      body_data = JTT809Header.decrypt(header.encrypt_key, body_data)
    }
    let body = null
    if (header.message_id in main_link) {
      body = main_link[header.message_id].decode(body_data)
    } else if (header.message_id in slave_link) {
      body = slave_link[header.message_id].decode(body_data)
    }

    return {
      header,
      body
    }
  } else {
    return {
      error: 'crc校验不通过'
    }
  }
}


function create_server(header, center_id, port) {
  return new Promise((resolve, reject) => {
    const server = net.createServer()
    servers[center_id] = server
    server.on('connection', (clientSocket) => {
      console.log('有新的客户端连接了')
      sockets[center_id] = clientSocket
      clientSocket.on('data', (data) => {
        console.log(`来自${center_id}从链路消息:`, data)
        const result = decode_809(data)
        if (result) {
          if (result.header.message_id === '9001') {
            header.message_id = '9002'
            const body9002 = { result: 0 }
            clientSocket.write(encode_809(header, body9002))
          }
          if (result.header.message_id === '9005') {
            header.message_id = '9006'
            const body9006 = Buffer.from([])
            clientSocket.write(encode_809(header, body9006))
          }
        } else {
          reject(data)
        }

      })
    })

    server.listen({ port, host: '172.16.2.52', exclusive: true }, (err) => {
      if (err) {
        reject(err)
      }
      resolve()
    })

    server.once('close', (err) => {
      console.log(`${center_id}从链路已经关闭`, err)
      reject()
    })
  })
}

function create_client(center_id) {
  return new Promise((resolve, reject) => {
    client = net.createConnection({
      host: 'gateway-alpha.smart-iov.net',
      port: 20809,
    }, () => {
      console.log('开始连接')
      clients[center_id] = client
      resolve()
    })

  })
}

function sendMessage(message, center_id) {
  return new Promise((resolve, reject) => {
    const client = clients[center_id]
    client.write(message)

    client.on('data', (data) => {
      console.log(`来自${center_id}主链路消息:`, data)
      const result = decode_809(data)
      if (result.header.message_id === '1002') {
        resolve(result.body.result)
      }
    })

    client.once('close', (err) => {
      console.log(`${center_id}主链路已经关闭`, err)
      if (sockets[center_id]) {
        clearInterval(interval)
        sockets[center_id].destroy()
        servers[center_id].close()
      }
      resolve('登陆失败，请重试')
    })
  })
}

function keepAlive(result, header, center_id, maxAge) {
  if (result === '00') {
    interval = setInterval(() => {
      header.message_id = '1005'
      const body1005 = Buffer.from([])
      if (!clients[center_id].destroyed) {
        clients[center_id].write(encode_809(header, body1005))
      }
    }, 5000)

    setTimeout(() => {
      clearInterval(interval)
      clients[center_id].destroy()
      sockets[center_id].destroy()
      servers[center_id].close()
    }, maxAge)
  }
}

/*  808--------------------------------------------------------------------------------------------------------------------------*/
function escape(data) {
  const array = []
  for (let index = 0; index < data.length; index++) {
    let element = data[index].toString('16').padStart(2, '0');
    array.push(element)
  }
  const escape_array = array.map(x => {
    switch (x) {
      case '7d':
        return '7d01'
      case '7e':
        return '7d02'
      default:
        return x
    }
  })
  const escape_buf_array = escape_array.map(x => {
    return Buffer.from(x, 'hex')

  })
  return Buffer.concat(escape_buf_array)
}

function unescape(data) {
  const array = []
  for (let index = 0; index < data.length; index++) {
    let element = data[index].toString('16').padStart(2, '0');
    array.push(element)
  }
  for (let index = 0; index < array.length; index++) {
    if (array[index] === '7d' && array[index + 1] === '02') {
      array[index] = '7e'
      array.splice(index + 1, 1)
    }
    if (array[index] === '7d' && array[index + 1] === '01') {
      array[index] = '7d'
      array.splice(index + 1, 1)
    }
  }
  const unescape_buf_array = array.map(x => {
    return Buffer.from(x, 'hex')

  })
  return Buffer.concat(unescape_buf_array)

}

function decode_808(data) {
  const unescape_data = unescape(data.slice(1, -1))
  if (JTT808header.validate(unescape_data)) {
    const header_body_data = unescape_data.slice(0, -1)

    const header = JTT808header.decode(header_body_data)
    const { is_split, body_length, phone_number, message_id, packet_number, total_packets, is_encrypted } = header

    let body_data = header_body_data.slice(-body_length)

    // if (is_split) {
    //     if (!(phone_number in split_packets)) {
    //         split_packets[phone_number] = {}
    //     }
    //     if (!(message_id in split_packets[phone_number])) {
    //         split_packets[phone_number][message_id] = {}
    //     }
    //     if (!(packet_number in split_packets[phone_number][message_id])) {
    //         split_packets[phone_number][message_id][packet_number] = body_data
    //         console.log(split_packets);

    //     }
    //     if (packet_number === total_packets) {
    //         body_data = Buffer.from([])
    //         for (let packet_number = 1; packet_number < total_packets + 1; packet_number++) {
    //             body_data = Buffer.concat([body_data, split_packets[phone_number][message_id][packet_number]])
    //         }
    //         split_packets = {}
    //     }
    // }

    if (is_encrypted === 1) {
      body_data = key.decrypt(body_data)
    }
    const body = MESSAGE[message_id].decode(body_data)
    return {
      header,
      body,
    }
  }
}

function encode_808(header, body) {
  let body_buf = MESSAGE[header.message_id].encode(body)
  if (header.is_encrypted === 1) {
    body_buf = key.encrypt(body_buf)
  }

  const MAX_BODY_LEN = (1 << 10) - 1
  const total_packets = parseInt(body_buf.length / MAX_BODY_LEN) + 1

  let data = Buffer.from([])

  for (let packet_number = 1; packet_number < total_packets + 1; packet_number++) {
    let split_body_buf = body_buf.slice((packet_number - 1) * MAX_BODY_LEN)
    if (packet_number !== total_packets) {
      split_body_buf = body_buf.slice((packet_number - 1) * MAX_BODY_LEN, packet_number * MAX_BODY_LEN)
    }

    header.is_split = total_packets === 1 ? 0 : 1
    header.body_length = split_body_buf.length
    header.total_packets = total_packets
    header.packet_number = packet_number

    const header_data = JTT808header.encode(header)
    const header_body_buf = JTT808header.fill(Buffer.concat([header_data, split_body_buf]))
    const flag = Buffer.from([0x7e])
    data = Buffer.concat([flag, escape(header_body_buf), flag])

  }
  return data

}

function create_client808() {
  return new Promise((resolve, reject) => {
    client808 = net.createConnection({
      host: 'gateway-alpha.smart-iov.net',
      port: 10808,
    }, () => {
      console.log('开始连接')
      resolve()
    })

  })
}

function sendMessage808(message) {
  return new Promise((resolve, reject) => {
    client808.write(message)
    flow_number += 1

    client808.on('data', (data) => {
      console.log(`来自平台消息:`, data)
      const result = decode_808(data)
      console.log(`来自平台消息:`, result);
      if (result.header.message_id === '8100') {
        resolve({
          'code': result.body.authentication_code,
          'result': result.body.result
        })
      }
      if (result.header.message_id === '8001') {
        resolve(result.body.result)
      }
    })

    client808.once('close', (err) => {
      console.log(`TCP连接已经关闭`, err)
    })
  })
}

router.post('/api/login', async (ctx, next) => {

  const data = ctx.request.body

  if (data.protocol === 808) {
    const header = {
      message_id: undefined,
      body_length: undefined,
      is_encrypted: 0,
      is_split: undefined,
      phone_number: data.value.deviceSN,
      flow_number,
      total_packets: undefined,
      packet_number: undefined,
    }
    header.message_id = '0100'
    let message = encode_808(header, MESSAGE[header.message_id].body)
    await create_client808()
    let { code, result } = await sendMessage808(message)
    result = login_result_808[result]

    if (code) {
      phoneNumber = data.value.deviceSN
      JTT808body0102.setCode(code)
      header.message_id = '0102'
      message = encode_808(header, MESSAGE[header.message_id].body)
      result = await sendMessage808(message)
    }


    ctx.body = {
      status: 200,
      message: '操作成功',
      result,
    }
  }

  if (data.protocol === 809) {
    const { center_id, encrypt_flag, encrypt_key, user_id, password, down_link_ip, down_link_port } = data.value
    centerId = center_id
    const header = {
      body_length: undefined,
      serial_number: 105,
      message_id: '1001',
      center_id,
      version_flag: '010000',
      encrypt_flag,
      encrypt_key,
    }
    const body = {
      user_id,
      password,
      down_link_ip,
      down_link_port
    }

    const message = encode_809(header, body)
    const params = decode_809(message)
    let result = undefined
    let { username, maxAge } = ctx.session
    console.log(username);

    if (clients[username] && !clients[username].destroyed) {
      result = '链路已连接'
    } else {
      ctx.session.username = center_id
      await create_server(header, ctx.session.username, down_link_port)
      await create_client(ctx.session.username)
      result = await sendMessage(message, ctx.session.username)
      keepAlive(result, header, ctx.session.username, maxAge)
    }

    ctx.body = {
      status: 200,
      message: '操作成功',
      Buffer: message.toString('hex'),
      result,
      params
    }

  }

})

router.post('/api/business', async (ctx, next) => {

  const data = ctx.request.body
  if (data.protocol === 808) {
    const header = {
      message_id: undefined,
      body_length: undefined,
      is_encrypted: 0,
      is_split: undefined,
      phone_number: phoneNumber,
      flow_number,
      total_packets: undefined,
      packet_number: undefined,
    }
    header.message_id = data.business
    const message = encode_808(header, MESSAGE[header.message_id].body)
    const params = decode_808(message)
    ctx.body = {
      status: 200,
      message: '操作成功',
      Buffer: message.toString('hex'),
      params,
    }
  }
  if (data.protocol === 809) {
    const { value } = ctx.request.body
    const { business, sub_business } = value
    const header = {
      body_length: undefined,
      serial_number: 105,
      message_id: business,
      center_id: centerId,
      version_flag: '100000',
      encrypt_flag: 0,
      encrypt_key: 0,
    }

    let message = Buffer.from([])
    if (header.message_id in main_link) {
      message = encode_809(header, main_link[header.message_id].body[sub_business])
    } else if (header.message_id in slave_link) {
      message = encode_809(header, slave_link[header.message_id].body[sub_business])
    }

    const params = decode_809(message)

    ctx.body = {
      status: 200,
      message: '操作成功',
      Buffer: message.toString('hex'),
      params
    }
  }
})


router.post('/api/generate', async (ctx, next) => {
  const { value, protocol } = ctx.request.body
  const { header, body } = value

  const Buffer = protocol === 808 ? encode_808(header, body).toString('hex') : encode_809(header, body).toString('hex')

  ctx.body = {
    status: 200,
    message: '操作成功',
    Buffer,
  }
})

router.post('/api/send', async (ctx, next) => {
  const data = ctx.request.body

  if (data.protocol === 808) {
    let result = '链路已断开，请重新连接'
    if (client808 && !client808.destroyed) {
      result = await sendMessage808(Buffer.from(data.value.decode, 'hex'))
    }

    ctx.body = {
      status: 200,
      message: '操作成功',
      result,
    }

  }

  if (data.protocol === 809) {
    const { username } = ctx.session

    const buffer = Buffer.from(data.value.decode, 'hex')
    const business = decode_809(buffer).header.message_id
    const sub_business = decode_809(buffer).body.data_type
    let result = '链路已断开，请重新连接'
    if (username) {
      if (clients[username] && !clients[username].destroyed && sockets[username]) {
        if (business in main_link) {
          clients[username].write(buffer)
          console.log('主链路发送', business, sub_business, buffer);
          result = '已通过主链路发送'

        } else if (business in slave_link) {
          sockets[username].write(buffer)
          console.log('从链路发送', business, sub_business, buffer);
          result = '已通过从链路发送'
        }
      }
    }


    ctx.body = {
      status: 200,
      message: '操作成功',
      result,
    }
  }

})

router.get('/api/close', async (ctx) => {

  const result = '链路已断开'
  if (client808 && !client808.destroyed) {
    client808.destroy()
  }

  const { username } = ctx.session
  if (clients[username] && !clients[username].destroyed) {
    clearInterval(interval)
    clients[username].destroy()
    sockets[username].destroy()
    servers[username].close()
  }

  ctx.body = {
    status: 200,
    message: '操作成功',
    result
  }

})


module.exports = router
